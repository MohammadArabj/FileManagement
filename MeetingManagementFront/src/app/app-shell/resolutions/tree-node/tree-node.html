<div class="tree-node" [class.tree-node-root]="isRoot">
    <!-- Node Header -->
    <div class="tree-node-header" [style.margin-right.px]="level * 30">
        <div class="node-card" [class.node-card-root]="isRoot" [class.node-card-referral]="node.isReferral">
            <!-- Toggle Button -->
            @if (node.children.length > 0) {
            <button class="btn-toggle" (click)="toggleNode()">
                <i class="fa" [class.fa-chevron-down]="isExpanded" [class.fa-chevron-left]="!isExpanded"></i>
            </button>
            } @else {
            <div class="btn-toggle-placeholder"></div>
            }

            <!-- Node Info -->
            <div class="node-info flex-grow-1">
                <div class="node-header-row">
                    <div class="node-title">
                        @if (node.isReferral) {
                        <i class="fa fa-share text-warning ms-2"></i>
                        ارجاع به: <strong>{{ node.actorName }}</strong>
                        } @else {
                        <i class="fa fa-user-check text-primary ms-2"></i>
                        مسئول اصلی: <strong>{{ node.actorName }}</strong>
                        }
                    </div>

                    <div class="node-badges">
                        <!-- Status Badges -->
                        <span class="badge bg-light text-dark border me-2 w-auto">
                            سطح {{ node.level }}
                        </span>

                        @if (node.actionStatus) {
                        <span class="badge me-2 w-auto" [ngClass]="getActionStatusClass()">
                            <i class="fa fa-tasks ms-1"></i>
                            {{ getStatusText(node.actionStatus) }}
                        </span>
                        }

                        @if (node.followStatus) {
                        <span class="badge me-2 w-auto" [ngClass]="getFollowStatusClass()">
                            <i class="fa fa-eye ms-1"></i>
                            {{ getStatusText(node.followStatus) }}
                        </span>
                        }

                        <!-- Children Count -->
                        @if (node.children.length > 0) {
                        <span class="badge bg-info w-auto">
                            <i class="fa fa-sitemap ms-1"></i>
                            {{ node.children.length }} ارجاع
                        </span>
                        }
                    </div>
                </div>

                <!-- Referral Info -->
                @if (node.isReferral && node.referrerName) {
                <div class="referral-info mt-2">
                    <small class="text-muted">
                        <i class="fa fa-user ms-1"></i>
                        ارجاع دهنده: <span class="fw-semibold">{{ node.referrerName }}</span>
                        @if (node.referralDate) {
                        <i class="fa fa-calendar ms-3"></i>
                        تاریخ ارجاع: <span class="fw-semibold">{{ node.referralDate }}</span>
                        }
                    </small>
                    @if (node.referralNote) {
                    <div class="referral-note mt-1">
                        <small class="text-secondary">
                            <i class="fa fa-sticky-note ms-1"></i>
                            {{ node.referralNote }}
                        </small>
                    </div>
                    }
                </div>
                }

                <!-- Due Date -->
                @if (node.dueDate) {
                <div class="due-date mt-2">
                    <small class="text-muted">
                        <i class="fa fa-clock ms-1"></i>
                        مهلت: <span class="fw-semibold text-danger">{{ node.dueDate }}</span>
                    </small>
                </div>
                }
            </div>

            <!-- Action Buttons -->
            <!-- <div class="node-actions">
                <div class="btn-group">
                    @if (canPerformAction()) {
                    <button class="btn btn-sm btn-outline-success" (click)="onAddAction.emit(node)"
                        title="افزودن اقدام">
                        <i class="fa fa-plus me-1"></i>
                        اقدام
                    </button>
                    }

                    @if (canPerformFollowup()) {
                    <button class="btn btn-sm btn-outline-info" (click)="toggleFollowupForm()" title="افزودن پیگیری">
                        <i class="fa fa-eye me-1"></i>
                        پیگیری
                    </button>
                    }

                    @if (node.canRefer) {
                    <button class="btn btn-sm btn-outline-warning" (click)="onCreateReferral.emit(node)"
                        title="ایجاد ارجاع">
                        <i class="fa fa-share me-1"></i>
                        ارجاع
                    </button>
                    }
                </div>
            </div> -->
        </div>

        <!-- Inline Followup Form -->
        @if (showFollowupForm()) {
        <div class="inline-followup-form mt-3" [style.margin-right.px]="(level + 1) * 30">
            <div class="card border-info">
                <div class="card-header bg-info bg-opacity-10 py-2">
                    <h6 class="mb-0 text-info d-flex align-items-center justify-content-between">
                        <span>
                            <i class="fa fa-eye me-2"></i>
                            ثبت پیگیری جدید - {{ node.actorName }}
                        </span>
                        <button type="button" class="btn-close btn-close-sm" (click)="closeFollowupForm()"></button>
                    </h6>
                </div>
                <div class="card-body p-3">
                    <form (ngSubmit)="submitFollowup()">
                        <div class="row g-3">
                            <!-- Status Selection -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <i class="fa fa-flag me-1"></i>
                                    وضعیت پیگیری <span class="text-danger">*</span>
                                </label>
                                <select class="form-select form-select-sm" [(ngModel)]="followupStatus"
                                    name="followupStatus" required>
                                    <option value="">انتخاب کنید...</option>
                                    <option value="FollowingUp">در حال پیگیری</option>
                                    <option value="NotFollowedUp">پیگیری نشده</option>
                                </select>
                            </div>

                            <!-- Date Input -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <i class="fa fa-calendar me-1"></i>
                                    تاریخ <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="followupDate"
                                    name="followupDate" data-jdp placeholder="انتخاب تاریخ..." required>
                            </div>

                            <!-- Description -->
                            <div class="col-12">
                                <label class="form-label fw-semibold">
                                    <i class="fa fa-comment-dots me-1"></i>
                                    توضیحات
                                    @if (followupStatus !== 'Done') {
                                    <span class="text-danger">*</span>
                                    }
                                </label>
                                <textarea rows="3" class="form-control form-control-sm"
                                    [(ngModel)]="followupDescription" name="followupDescription"
                                    placeholder="توضیحات پیگیری خود را وارد کنید..."
                                    [required]="followupStatus !== 'Done'"></textarea>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                (click)="closeFollowupForm()">
                                <i class="fa fa-times me-1"></i>انصراف
                            </button>
                            <button type="submit" class="btn btn-info btn-sm" [disabled]="isSaving()">
                                @if (isSaving()) {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                                } @else {
                                <i class="fa fa-save me-1"></i>
                                }
                                ثبت پیگیری
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        }
    </div>

    <!-- Node Content (Actions & Followups) -->
    @if (isExpanded) {
    <div class="tree-node-content" [style.margin-right.px]="(level + 1) * 30">
        <!-- Actions Section -->
        @if (node.actions.length > 0) {
        <div class="section-card mb-3">
            <div class="section-header">
                <h6 class="fw-bold mb-0">
                    <i class="fa fa-tasks text-success me-2"></i>
                    اقدامات
                    <span class="badge bg-success-subtle text-success ms-2">{{ node.actions.length }}</span>
                </h6>
            </div>

            <div class="items-container p-3">
                @for (action of node.actions; track action.id) {
                <div class="item-card action-item mb-3">
                    <div class="item-header">
                        <span class="status-badge" [class]="getStatusClass(action.statusStr || '')">
                            {{ getStatusText(action.statusStr || '') }}
                        </span>
                        <!-- @if (canEditAction(action)) {
                        <div class="item-actions">
                            <button class="btn btn-sm btn-outline-primary" (click)="editAction(action, 'action')"
                                title="ویرایش">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" (click)="onDeleteAction.emit(action.id)"
                                title="حذف">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                        } -->
                    </div>

                    <div class="item-content">
                        @if (action.description) {
                        <p class="description">{{ action.description }}</p>
                        }
                        <div class="meta-info">
                            <span class="meta-item">
                                <i class="fa fa-user me-1"></i>{{ action.userName || 'نامشخص' }}
                            </span>
                            <span class="meta-item">
                                <i class="fa fa-calendar me-1"></i>{{ action.date }}
                            </span>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>
        }

        <!-- Followups Section -->
        @if (node.followups.length > 0) {
        <div class="section-card mb-3">
            <div class="section-header">
                <h6 class="fw-bold mb-0">
                    <i class="fa fa-eye text-info me-2"></i>
                    پیگیری‌ها
                    <span class="badge bg-info-subtle text-info ms-2">{{ node.followups.length }}</span>
                </h6>
            </div>

            <div class="items-container p-3">
                @for (followup of node.followups; track followup.id) {
                <div class="item-card followup-item mb-3">
                    <div class="item-header">
                        <span class="status-badge" [class]="getStatusClass(followup.followStatusStr || '')">
                            {{ getStatusText(followup.followStatusStr || '') }}
                        </span>
                        <!-- @if (canEditAction(followup)) {
                        <div class="item-actions">
                            <button class="btn btn-sm btn-outline-primary" (click)="editAction(followup, 'follow')"
                                title="ویرایش">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" (click)="onDeleteAction.emit(followup.id)"
                                title="حذف">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                        } -->
                    </div>

                    <div class="item-content">
                        @if (followup.description) {
                        <p class="description">{{ followup.description }}</p>
                        }
                        <div class="meta-info">
                            <span class="meta-item">
                                <i class="fa fa-user me-1"></i>{{ followup.userName || 'نامشخص' }}
                            </span>
                            <span class="meta-item">
                                <i class="fa fa-calendar me-1"></i>{{ followup.date }}
                            </span>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>
        }

        <!-- Empty State -->
        @if (node.actions.length === 0 && node.followups.length === 0) {
        <div class="empty-state text-center py-4">
            <i class="fa fa-info-circle text-muted mb-2" style="font-size: 2rem;"></i>
            <p class="text-muted mb-0">هیچ اقدام یا پیگیری‌ای ثبت نشده است</p>
        </div>
        }
    </div>
    }

    <!-- Children Nodes -->
    @if (isExpanded && node.children.length > 0) {
    <div class="tree-children">
        @for (child of node.children; track child.id) {
        <app-tree-node [node]="child" [level]="level + 1" [isRoot]="false" [expandedNodes]="expandedNodes"
            [currentUserGuid]="currentUserGuid" [assignmentData]="assignmentData"
            (onNodeToggle)="onNodeToggle.emit($event)" (onAddAction)="onAddAction.emit($event)"
            (onAddFollowup)="onAddFollowup.emit($event)" (onEditAction)="onEditAction.emit($event)"
            (onDeleteAction)="onDeleteAction.emit($event)" (onCreateReferral)="onCreateReferral.emit($event)"
            (onViewDetails)="onViewDetails.emit($event)"
            (onFollowupSubmit)="onFollowupSubmit.emit($event)"></app-tree-node>
        }
    </div>
    }
</div>